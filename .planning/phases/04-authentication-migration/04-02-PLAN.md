---
phase: 04-authentication-migration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - infra/lambda/user-migration/index.ts
  - infra/lambda/user-migration/package.json
  - infra/cognito-setup.md
autonomous: true
user_setup:
  - service: aws-lambda
    why: "Deploy User Migration Lambda trigger"
    dashboard_config:
      - task: "Create Lambda function 'rpg-user-migration'"
        location: "AWS Console -> Lambda -> Create Function"
      - task: "Attach Lambda as User Migration trigger to Cognito User Pool"
        location: "AWS Console -> Cognito -> User Pool -> Triggers -> User Migration"
      - task: "Configure Lambda environment variables (DATABASE_URL)"
        location: "AWS Console -> Lambda -> Configuration -> Environment Variables"
      - task: "Add VPC configuration if RDS is in VPC"
        location: "AWS Console -> Lambda -> Configuration -> VPC"

must_haves:
  truths:
    - "User Migration Lambda validates passwords against PostgreSQL"
    - "Lambda returns correct user attributes for Cognito auto-creation"
    - "Lambda handles both UserMigration_Authentication and UserMigration_ForgotPassword triggers"
    - "Migrated users get custom:legacy_id attribute with PostgreSQL UUID"
  artifacts:
    - path: "infra/lambda/user-migration/index.ts"
      provides: "User Migration Lambda handler"
      exports: ["handler"]
      min_lines: 50
    - path: "infra/lambda/user-migration/package.json"
      provides: "Lambda dependencies"
      contains: "bcrypt"
  key_links:
    - from: "infra/lambda/user-migration/index.ts"
      to: "PostgreSQL User table"
      via: "bcrypt.compareSync"
      pattern: "compareSync.*password"
    - from: "infra/lambda/user-migration/index.ts"
      to: "Cognito User Pool"
      via: "Lambda trigger response"
      pattern: "userAttributes"
---

<objective>
Create the User Migration Lambda function that enables just-in-time user migration from PostgreSQL to Cognito.

Purpose: Allow existing users to log in to Cognito using their current passwords without forced resets (AUTH-04).
Output: Lambda function code ready for deployment, updated Cognito setup docs with Lambda configuration.
</objective>

<execution_context>
@C:\Users\gpope1\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpope1\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-authentication-migration/04-RESEARCH.md
@.planning/phases/04-authentication-migration/04-01-SUMMARY.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create User Migration Lambda Function</name>
  <files>infra/lambda/user-migration/index.ts, infra/lambda/user-migration/package.json</files>
  <action>
Create the User Migration Lambda that validates credentials against PostgreSQL and returns user attributes for Cognito.

Research indicates (04-RESEARCH.md):
- Must use USER_PASSWORD_AUTH flow so Lambda receives password
- Lambda receives `event.request.userAttributes.username` (email) and password
- Must return `userAttributes` array with name/value pairs
- Must set `autoConfirmUser: true` to skip confirmation
- Include `custom:legacy_id` with PostgreSQL UUID for data migration mapping

Create directory structure: `infra/lambda/user-migration/`

1. Create `infra/lambda/user-migration/package.json`:
```json
{
  "name": "user-migration-lambda",
  "version": "1.0.0",
  "main": "index.js",
  "dependencies": {
    "bcrypt": "^5.1.1",
    "pg": "^8.11.3"
  },
  "devDependencies": {
    "@types/aws-lambda": "^8.10.131",
    "@types/bcrypt": "^5.0.2",
    "@types/node": "^20.10.0",
    "@types/pg": "^8.10.9",
    "typescript": "^5.3.2"
  }
}
```

Note: Using bcrypt 5.x for Lambda compatibility (6.x has native module issues).

2. Create `infra/lambda/user-migration/index.ts`:
```typescript
import bcrypt from "bcrypt";
import { Pool } from "pg";

// Connection pool (reused across invocations)
let pool: Pool | null = null;

function getPool(): Pool {
  if (!pool) {
    pool = new Pool({
      connectionString: process.env.DATABASE_URL,
      max: 1, // Lambda should use minimal connections
      idleTimeoutMillis: 120000,
      connectionTimeoutMillis: 10000,
    });
  }
  return pool;
}

interface CognitoUserMigrationEvent {
  triggerSource: "UserMigration_Authentication" | "UserMigration_ForgotPassword";
  userName: string;
  request: {
    password?: string;
    userAttributes?: Record<string, string>;
  };
  response: {
    userAttributes?: { Name: string; Value: string }[] | null;
    finalUserStatus?: string;
    messageAction?: string;
    forceAliasCreation?: boolean;
  };
}

export async function handler(event: CognitoUserMigrationEvent): Promise<CognitoUserMigrationEvent> {
  console.log("Trigger source:", event.triggerSource);
  console.log("Username (email):", event.userName);

  const email = event.userName;

  try {
    const db = getPool();
    const result = await db.query(
      'SELECT id, email, name, password FROM "User" WHERE email = $1',
      [email]
    );

    if (result.rows.length === 0) {
      console.log("User not found in legacy database");
      throw new Error("User not found");
    }

    const user = result.rows[0];

    if (event.triggerSource === "UserMigration_Authentication") {
      // Validate password for sign-in
      const password = event.request.password;
      if (!password) {
        throw new Error("Password not provided");
      }

      const isValid = await bcrypt.compare(password, user.password);
      if (!isValid) {
        console.log("Invalid password for user:", email);
        throw new Error("Invalid credentials");
      }

      console.log("Password validated, migrating user:", email);
    } else if (event.triggerSource === "UserMigration_ForgotPassword") {
      // Allow password reset for existing users
      console.log("Forgot password flow, migrating user:", email);
    }

    // Return user attributes for Cognito to create the user
    event.response = {
      userAttributes: [
        { Name: "email", Value: user.email },
        { Name: "email_verified", Value: "true" },
        { Name: "name", Value: user.name || "" },
        { Name: "custom:legacy_id", Value: user.id }, // PostgreSQL UUID for data mapping
      ],
      finalUserStatus: "CONFIRMED",
      messageAction: "SUPPRESS", // Don't send welcome email
      forceAliasCreation: false,
    };

    console.log("User migration successful:", email);
    return event;
  } catch (error) {
    console.error("Migration error:", error);
    throw error; // Cognito will show "Incorrect username or password"
  }
}
```

3. Create `infra/lambda/user-migration/tsconfig.json`:
```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "outDir": "./dist",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true
  },
  "include": ["*.ts"],
  "exclude": ["node_modules"]
}
```

IMPORTANT: This Lambda requires DATABASE_URL environment variable pointing to PostgreSQL. If RDS is in a VPC, Lambda needs VPC configuration with appropriate security group.
  </action>
  <verify>
- Directory exists: `ls infra/lambda/user-migration/`
- TypeScript compiles: `cd infra/lambda/user-migration && npx tsc --noEmit`
- package.json has bcrypt and pg dependencies
- Handler exports correctly named function
  </verify>
  <done>
User Migration Lambda code complete. Handles both authentication and forgot-password flows, maps PostgreSQL UUID to custom:legacy_id attribute.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Cognito Setup Docs with Lambda Deployment</name>
  <files>infra/cognito-setup.md</files>
  <action>
Append Lambda deployment instructions to the existing Cognito setup documentation.

Add new section to `infra/cognito-setup.md`:

```markdown
## User Migration Lambda Setup

The User Migration Lambda enables just-in-time migration of existing users from PostgreSQL to Cognito.

### Prerequisites
- Cognito User Pool created (previous section)
- DATABASE_URL for PostgreSQL available
- AWS CLI configured with appropriate permissions

### Step 1: Build Lambda Package

```bash
cd infra/lambda/user-migration
npm install
npx tsc
# Create deployment package
zip -r ../user-migration.zip dist/ node_modules/
```

### Step 2: Create Lambda Function

1. Go to AWS Lambda Console
2. Create function:
   - Name: `rpg-user-migration`
   - Runtime: Node.js 20.x
   - Architecture: x86_64
   - Handler: `dist/index.handler`

3. Upload the zip file from `infra/lambda/user-migration.zip`

### Step 3: Configure Environment Variables

In Lambda Configuration -> Environment Variables:
- `DATABASE_URL`: Your PostgreSQL connection string

### Step 4: Configure VPC (if RDS is in VPC)

In Lambda Configuration -> VPC:
- Select the VPC containing your RDS instance
- Select subnets with RDS access
- Select security group allowing PostgreSQL port (5432)

### Step 5: Set Lambda Timeout

In Lambda Configuration -> General:
- Timeout: 10 seconds (bcrypt is CPU-intensive)
- Memory: 256 MB minimum

### Step 6: Attach to Cognito User Pool

1. Go to Cognito Console -> Your User Pool
2. Navigate to: User Pool Properties -> Triggers
3. Under "User Migration":
   - Select the `rpg-user-migration` Lambda function
4. Save changes

### Testing the Lambda

Test with a known user:
1. Attempt sign-in to Cognito with existing PostgreSQL credentials
2. Lambda should validate and create user in Cognito
3. Check CloudWatch logs for migration output

### Rollback

If issues occur:
1. Remove Lambda trigger from Cognito User Pool
2. Users will fail sign-in (expected)
3. Investigate CloudWatch logs
4. Re-attach trigger after fix
```
  </action>
  <verify>
- `infra/cognito-setup.md` contains "User Migration Lambda Setup" section
- Instructions include build, deploy, VPC, and trigger attachment steps
- Rollback procedure documented
  </verify>
  <done>
Cognito setup documentation updated with complete Lambda deployment instructions. User can deploy and configure the migration Lambda.
  </done>
</task>

</tasks>

<verification>
1. Lambda code exists: `ls infra/lambda/user-migration/`
2. TypeScript compiles: `cd infra/lambda/user-migration && npx tsc --noEmit`
3. Setup docs updated: `grep "User Migration Lambda" infra/cognito-setup.md`
4. Lambda handles both trigger types: `grep "UserMigration_" infra/lambda/user-migration/index.ts`
</verification>

<success_criteria>
- User Migration Lambda validates passwords using bcrypt
- Lambda returns correct Cognito user attributes including custom:legacy_id
- Lambda handles both Authentication and ForgotPassword triggers
- Deployment documentation complete with VPC and timeout guidance
- Covers requirement: AUTH-04 (just-in-time migration)
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-migration/04-02-SUMMARY.md`
</output>
