---
phase: 04-authentication-migration
plan: 04
type: execute
wave: 4
depends_on: ["04-03"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "User can sign up via Cognito hosted UI"
    - "Existing user can log in with PostgreSQL password (migration Lambda works)"
    - "Session persists across browser restart"
    - "Protected routes redirect unauthenticated users to login"
    - "User ID in session is Cognito 'sub' claim"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete Cognito authentication flow works end-to-end, including user migration.

Purpose: Confirm all AUTH requirements are met before proceeding to database migration (Phase 5).
Output: Verification checkpoint confirming auth migration success.
</objective>

<execution_context>
@C:\Users\gpope1\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpope1\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-authentication-migration/04-01-SUMMARY.md
@.planning/phases/04-authentication-migration/04-02-SUMMARY.md
@.planning/phases/04-authentication-migration/04-03-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify Complete Authentication Flow</name>
  <what-built>
Complete Cognito authentication integration:
- Cognito User Pool with USER_PASSWORD_AUTH enabled
- User Migration Lambda deployed and attached as trigger
- Auth.js configured with Cognito provider
- JWT token refresh handling
- Protected route middleware
  </what-built>
  <how-to-verify>
**Pre-requisites (user setup from previous plans):**
1. Cognito User Pool created per infra/cognito-setup.md
2. User Migration Lambda deployed and attached
3. Environment variables configured in .env.local:
   - COGNITO_USER_POOL_ID
   - COGNITO_CLIENT_ID
   - COGNITO_CLIENT_SECRET
   - COGNITO_ISSUER

**Test 1: New User Registration**
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/login
3. Click "Sign up" (redirects to Cognito hosted UI)
4. Create a new account with email + password
5. Verify email (check inbox for Cognito verification code)
6. Complete sign-up flow
7. Verify: Redirected to app dashboard, user ID visible in session

**Test 2: Existing User Migration**
1. Log out if logged in
2. Navigate to http://localhost:3000/login
3. Sign in with an existing PostgreSQL user's email and password
4. Verify: Login succeeds WITHOUT password reset
5. Check CloudWatch logs for Lambda invocation with "User migration successful"
6. Verify: Session shows Cognito 'sub' as user ID (UUID format, different from PostgreSQL ID)

**Test 3: Session Persistence**
1. While logged in, close browser completely
2. Reopen browser and navigate to http://localhost:3000
3. Verify: Still logged in (refresh token persisted in cookie)

**Test 4: Protected Route**
1. Log out
2. Try to access http://localhost:3000/campaigns
3. Verify: Redirected to /login

**Test 5: Token Refresh (optional, requires waiting)**
1. Login and stay on a page for >1 hour
2. Perform an action (e.g., navigate to another page)
3. Verify: No login prompt, access token was refreshed automatically
4. Check browser dev tools Network tab for token refresh calls

**Test 6: User ID for DynamoDB**
1. While logged in, open browser dev tools
2. In console, check session: the user ID should be a Cognito 'sub' format
3. This ID will be used as DynamoDB partition key in Phase 5
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass.

If issues found, describe:
- Which test failed
- Error message or unexpected behavior
- CloudWatch Lambda logs if migration failed
  </resume-signal>
</task>

</tasks>

<verification>
Human verification of complete auth flow including:
1. New user sign-up via Cognito
2. Existing user migration (password works)
3. Session persistence
4. Route protection
5. Token refresh
6. Correct user ID format for DynamoDB
</verification>

<success_criteria>
All 6 verification tests pass:
- New users can register via Cognito hosted UI
- Existing users login with current passwords (Lambda migrates them)
- Sessions persist across browser restarts
- Protected routes redirect to login
- Tokens refresh automatically before expiry
- User ID is Cognito 'sub' claim (ready for DynamoDB partition key)

Requirements covered: AUTH-02, AUTH-03, AUTH-04, AUTH-05, AUTH-06
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-migration/04-04-SUMMARY.md`
</output>
