---
phase: 04-authentication-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/cognito-setup.md
  - scripts/export-users.ts
  - .env.example
autonomous: true
user_setup:
  - service: aws-cognito
    why: "Create Cognito User Pool for authentication"
    env_vars:
      - name: COGNITO_USER_POOL_ID
        source: "AWS Console -> Cognito -> User Pools -> Pool ID"
      - name: COGNITO_CLIENT_ID
        source: "AWS Console -> Cognito -> App Clients -> Client ID"
      - name: COGNITO_CLIENT_SECRET
        source: "AWS Console -> Cognito -> App Clients -> Client Secret"
      - name: COGNITO_ISSUER
        source: "Format: https://cognito-idp.{region}.amazonaws.com/{poolId}"
    dashboard_config:
      - task: "Create User Pool with email sign-in"
        location: "AWS Console -> Cognito -> Create User Pool"
      - task: "Create App Client with USER_PASSWORD_AUTH enabled"
        location: "AWS Console -> Cognito -> App Clients"
      - task: "Add custom attribute 'custom:legacy_id'"
        location: "AWS Console -> Cognito -> User Pool -> Attributes"

must_haves:
  truths:
    - "Cognito User Pool exists with correct configuration"
    - "App Client supports USER_PASSWORD_AUTH flow for migration Lambda"
    - "All existing user data is exported and backed up"
    - "Environment variables documented for Cognito integration"
  artifacts:
    - path: "infra/cognito-setup.md"
      provides: "Cognito configuration documentation"
      contains: "User Pool ID"
    - path: "scripts/export-users.ts"
      provides: "User data export script"
      exports: ["exportUsers"]
    - path: ".env.example"
      provides: "Environment variable template"
      contains: "COGNITO_"
  key_links:
    - from: "scripts/export-users.ts"
      to: "prisma.user"
      via: "database query"
      pattern: "prisma\\.user\\.findMany"
---

<objective>
Set up AWS Cognito User Pool infrastructure and export existing user data for backup before migration.

Purpose: Create the foundation for Cognito-based authentication and ensure data safety before migration cutover.
Output: Cognito User Pool configuration docs, user data backup script, environment variable template.
</objective>

<execution_context>
@C:\Users\gpope1\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\gpope1\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-authentication-migration/04-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document Cognito User Pool Configuration</name>
  <files>infra/cognito-setup.md, .env.example</files>
  <action>
Create infrastructure documentation for the Cognito User Pool setup that the user will create in AWS Console:

1. Create `infra/cognito-setup.md` with step-by-step Cognito configuration:
   - User Pool name: `rpg-session-recorder-users`
   - Sign-in options: Email only (no username)
   - Password policy: Minimum 8 chars, requires numbers and special chars
   - MFA: Optional (user choice)
   - Self-service account recovery: Email only
   - Required attributes: email, name
   - Custom attributes: `custom:legacy_id` (String, mutable) for PostgreSQL UUID mapping
   - App Client name: `rpg-session-recorder-app`
   - Authentication flows: ENABLE `ALLOW_USER_PASSWORD_AUTH` (CRITICAL for migration Lambda)
   - OAuth scopes: openid, email, profile
   - Callback URLs: http://localhost:3000/api/auth/callback/cognito, https://yourdomain.com/api/auth/callback/cognito
   - Token expiration: Access token 1 hour, Refresh token 30 days
   - Enable refresh token rotation

2. Update `.env.example` with new Cognito environment variables:
   ```
   # AWS Cognito Configuration
   COGNITO_USER_POOL_ID=us-east-1_XXXXXXXXX
   COGNITO_CLIENT_ID=your-client-id
   COGNITO_CLIENT_SECRET=your-client-secret
   COGNITO_ISSUER=https://cognito-idp.us-east-1.amazonaws.com/us-east-1_XXXXXXXXX
   ```

IMPORTANT: Do NOT create actual AWS resources. Document what user needs to create manually. The user_setup in frontmatter will prompt them at execution time.
  </action>
  <verify>
- `infra/cognito-setup.md` exists with complete step-by-step instructions
- `.env.example` contains COGNITO_* variables with placeholder values
- Instructions explicitly mention USER_PASSWORD_AUTH requirement
  </verify>
  <done>
Cognito infrastructure documentation complete. User can follow instructions to create User Pool with correct configuration for migration.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create User Data Export Script</name>
  <files>scripts/export-users.ts</files>
  <action>
Create a TypeScript script to export all user data from PostgreSQL as backup before migration (AUTH-06).

Script requirements:
1. Connect to PostgreSQL using Prisma client
2. Export all users with fields: id, email, name, createdAt, updatedAt
3. Do NOT export password hashes (security risk if backup is compromised)
4. Write to JSON file: `backups/users-{timestamp}.json`
5. Log summary: total users exported, file location

Implementation:
```typescript
// scripts/export-users.ts
import { PrismaClient } from "@prisma/client";
import fs from "fs";
import path from "path";

const prisma = new PrismaClient();

export async function exportUsers() {
  const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
  const backupDir = path.join(process.cwd(), "backups");
  const filename = `users-${timestamp}.json`;
  const filepath = path.join(backupDir, filename);

  // Ensure backup directory exists
  if (!fs.existsSync(backupDir)) {
    fs.mkdirSync(backupDir, { recursive: true });
  }

  // Export users WITHOUT password hashes
  const users = await prisma.user.findMany({
    select: {
      id: true,
      email: true,
      name: true,
      createdAt: true,
      updatedAt: true,
      // Exclude: password
    },
  });

  fs.writeFileSync(filepath, JSON.stringify(users, null, 2));

  console.log(`Exported ${users.length} users to ${filepath}`);
  return { count: users.length, filepath };
}

// Run if executed directly
if (require.main === module) {
  exportUsers()
    .then((result) => {
      console.log("Export complete:", result);
      process.exit(0);
    })
    .catch((error) => {
      console.error("Export failed:", error);
      process.exit(1);
    });
}
```

Add `backups/` to `.gitignore` if not already present.
  </action>
  <verify>
- `scripts/export-users.ts` compiles without errors: `npx tsc --noEmit scripts/export-users.ts`
- Script can be run: `npx ts-node scripts/export-users.ts`
- Output JSON file created in `backups/` directory
- Password field is NOT included in export
  </verify>
  <done>
User data export script complete. Running script creates timestamped backup of all users (excluding passwords) for AUTH-06 compliance.
  </done>
</task>

</tasks>

<verification>
1. Infrastructure docs exist and are complete: `cat infra/cognito-setup.md`
2. Environment template updated: `grep COGNITO .env.example`
3. Export script runs successfully: `npx ts-node scripts/export-users.ts`
4. Backup file created with user data (no passwords)
</verification>

<success_criteria>
- Cognito setup documentation complete with USER_PASSWORD_AUTH explicitly mentioned
- Environment variable template includes all 4 Cognito variables
- User export script runs and creates backup file
- Backup excludes password hashes
- Covers requirements: AUTH-02 (docs), AUTH-06 (backup)
</success_criteria>

<output>
After completion, create `.planning/phases/04-authentication-migration/04-01-SUMMARY.md`
</output>
