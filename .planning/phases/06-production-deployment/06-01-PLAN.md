# 06-01-PLAN.md: Phase 1 of Production Deployment (Core Infrastructure & Foundation)

**Goal:** Deploy the core AWS infrastructure needed for a production launch using AWS Amplify. This plan covers setting up the Amplify app, connecting to a repository for CI/CD, and configuring environments for a Next.js application.

**Key Concepts:**
*   **AWS Amplify:** A managed service for deploying and hosting full-stack web applications. It will handle the CloudFront distribution, S3 bucket hosting, and CI/CD pipeline.
*   **Multi-Environment Setup:** We will establish `staging` and `production` environments within Amplify to enable safe testing and deployment workflows.

**Phase 6: Step 1 - Core Infrastructure & Foundation**

## 1. Create a New AWS Amplify App

**Objective:** Set up a new Amplify app in the AWS Console.

**Steps:**
1.1. **Navigate to AWS Amplify:** In the AWS Management Console, go to the Amplify service.
1.2. **Create New App:** Click "New app" and select "Host web app".
1.3. **Connect GitHub Repository:**
    *   Choose your repository provider (e.g., GitHub).
    *   Authorize Amplify to access your repositories.
    *   Select the repository for this project (`rpg`).
1.4. **Configure Build Settings:**
    *   Amplify will likely auto-detect that this is a Next.js application.
    *   Ensure the build command is set to `npm run build` (as per `package.json`).
    *   Create a new backend role if prompted, and ensure it has the necessary permissions (e.g., `s3:PutObject`, `s3:GetObject` for presigned URLs, and DynamoDB access).

## 2. Configure Environments and Environment Variables

**Objective:** Set up `staging` and `production` environments with the correct environment variables and secrets.

**Steps:**
2.1. **Create `staging` Branch:** In your Git repository, create a `staging` branch from your main development branch.
2.2. **Connect `staging` Branch in Amplify:** In the Amplify app console, connect the `staging` branch.
2.3. **Configure Environment Variables for `staging`:**
    *   In the Amplify console, navigate to "Environment variables" for the `staging` branch.
    *   Add the following environment variables (values can be from your `.env` or specific to staging):
        *   `NEXTAUTH_URL`: (The URL for your staging deployment, e.g., `https://staging.yourapp.com`)
        *   `COGNITO_USER_POOL_ID`
        *   `COGNITO_CLIENT_ID`
        *   `AWS_REGION`
        *   `DYNAMODB_TABLE_NAME`: (e.g., `rpg-staging`)
        *   `AWS_S3_BUCKET_NAME`: (e.g., `rpg-staging-s3-bucket`)
2.4. **Configure Secrets for `staging`:**
    *   Use AWS Secrets Manager to store `NEXTAUTH_SECRET`, `COGNITO_CLIENT_SECRET`.
    *   In Amplify, link these secrets to the corresponding environment variables.
2.5. **Configure `production` Environment:** Repeat steps 2.3 and 2.4 for the `main` or `production` branch, using production-level values.

## 3. Configure Infrastructure and Permissions

**Objective:** Ensure Amplify and other AWS services are correctly configured and have the necessary permissions.

**Steps:**
3.1. **VPC and Networking:**
    *   For now, we will rely on Amplify's default networking. A custom VPC with private subnets can be introduced later if required, but it adds complexity.
3.2. **DynamoDB Table:**
    *   The `rpg-prod` table already exists. A corresponding `rpg-staging` table should be created with the same schema (PK, SK, GSI1) for the staging environment.
3.3. **S3 Bucket for Audio:**
    *   Create separate S3 buckets for `staging` and `production` to store audio files.
    *   Configure lifecycle policies (e.g., Standard -> Standard-IA -> Glacier).
3.4. **IAM Role for Amplify:**
    *   Review the IAM role created by Amplify. Ensure it has permissions to:
        *   Read from Secrets Manager.
        *   Read/write to the DynamoDB tables (`rpg-staging`, `rpg-prod`).
        *   Read/write to the S3 buckets.

## 4. Initial Deployment and Verification

**Objective:** Trigger the first deployment and verify that the core infrastructure is working.

**Steps:**
4.1. **Trigger Deployment:** Pushing a commit to the `staging` branch should automatically trigger a build and deployment in Amplify.
4.2. **Verify Deployment:**
    *   Check the Amplify build logs for any errors.
    *   Access the Amplify-provided URL for the `staging` branch.
    *   Perform a basic smoke test (e.g., can you load the login page?).
4.3. **Verify Environment Variables:**
    *   Check application logs in CloudWatch to ensure environment variables are correctly loaded.
4.4. **Configure CloudWatch Alarms:**
    *   Set up basic CloudWatch alarms for:
        *   High error rates (e.g., >1% 4xx or 5xx errors).
        *   Cost anomalies using AWS Budgets.

---
**Dependencies:**
*   A GitHub repository containing the application code.
*   AWS account with permissions to create Amplify apps, S3 buckets, and IAM roles.
*   The `rpg-prod` DynamoDB table already exists. A `rpg-staging` table needs to be created.

**Acceptance Criteria:**
*   An AWS Amplify app is created and connected to the project's repository.
*   `staging` and `production` environments are configured with appropriate environment variables and secrets.
*   A successful deployment is triggered for the `staging` branch.
*   The application loads at the Amplify-provided URL for the staging environment.
