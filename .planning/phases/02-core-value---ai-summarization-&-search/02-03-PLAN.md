---
phase: 02-core-value---ai-summarization-&-search
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/lib/ai/summarize.ts, src/lib/inngest/functions.ts, src/app/api/transcribe-webhook/route.ts]
autonomous: true
user_setup:
  - service: Anthropic / AWS Bedrock
    why: "AI Summarization (Claude 3.5 Sonnet)"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Dashboard"
must_haves:
  truths:
    - "Sessions automatically trigger a summarization job after transcription"
    - "AI summaries are generated and stored in the database"
  artifacts:
    - path: "src/lib/ai/summarize.ts"
      provides: "Claude 3.5 summarization logic"
    - path: "src/lib/inngest/functions.ts"
      provides: "Summarization background job"
---

<objective>
Implement the AI summarization pipeline using Claude 3.5 and Inngest background jobs.

Purpose: Automatically generates high-quality narrative summaries of game sessions (AI-01).
Output: AI summarization logic, background job, and automatic trigger on transcription completion.
</objective>

<execution_context>
@./.gemini/get-shit-done/workflows/execute-plan.md
@./.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-value---ai-summarization-&-search/02-01-SUMMARY.md
@src/app/api/transcribe-webhook/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI Logic & Inngest Job</name>
  <files>src/lib/ai/summarize.ts, src/lib/inngest/functions.ts, package.json</files>
  <action>
    1. Install AI SDK: `npm install ai @ai-sdk/anthropic`.
    2. Create `src/lib/ai/summarize.ts`:
       - Use `generateText` with `anthropic('claude-3-5-sonnet-latest')`.
       - Implement a prompt that takes `transcriptText` and returns a structured summary (Executive Summary, Key NPCs, Plot Hooks, Memorable Quotes).
    3. Create `src/lib/inngest/functions.ts`:
       - Define an Inngest function `summarizeSessionJob` that triggers on `session/transcription.completed`.
       - The function fetches the session, calls the AI logic, and updates the `Session` record with the generated `summary`.
    4. Register the function in `src/app/api/inngest/route.ts`.
  </action>
  <verify>
    Mock an Inngest event and verify the function executes and updates a session record in the DB with a placeholder or real summary.
  </verify>
  <done>Summarization logic and background job are implemented and registered.</done>
</task>

<task type="auto">
  <name>Task 2: Trigger Summarization from Webhook</name>
  <files>src/app/api/transcribe-webhook/route.ts</files>
  <action>
    Update `src/app/api/transcribe-webhook/route.ts`:
    - After successfully updating the session with `transcriptText`, use the Inngest client to send a `session/transcription.completed` event with the `sessionId`.
  </action>
  <verify>
    Check Inngest Dev Server logs (if available) or verify the `summary` field in the database is populated after a transcription webhook mock.
  </verify>
  <done>Transcription completion now automatically triggers the AI summarization job.</done>
</task>

</tasks>

<verification>
- Inngest event is fired upon transcription completion.
- AI logic correctly processes transcript text into a structured summary.
</verification>

<success_criteria>
- A new session transcript results in an AI-generated summary stored in the DB without human intervention.
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-value---ai-summarization-&-search/02-03-SUMMARY.md`
</output>
