---
phase: 05-database-migration-validation
plan: 04
type: execute
wave: 4
depends_on: ["05-03"]
files_modified: [src/lib/search/dynamo-search.ts, scripts/validate-parity.ts, docs/rollback-procedure.md]
autonomous: true
---

<objective>
Implement DynamoDB-based keyword search and a data parity validation suite to monitor the migration's success. Document the rollback procedure.

Purpose: Validate that DynamoDB is a viable replacement for PostgreSQL before the final cutover.
Output: Search utility, consistency checker, and rollback documentation.
</objective>

<execution_context>
@./.gemini/get-shit-done/workflows/execute-plan.md
@./.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-database-migration-validation/05-03-SUMMARY.md
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DynamoDB Search Implementation</name>
  <files>src/lib/search/dynamo-search.ts</files>
  <action>
    Implement keyword search using `FilterExpression` on the Session entity:
    - Search session names, summaries, and metadata.
    - Use ElectroDB's `.filter()` or `.where()` capabilities.
    - Validate performance for campaigns with <50 sessions.
  </action>
  <verify>Run search queries against DynamoDB and compare results with existing PostgreSQL FTS results.</verify>
  <done>Keyword search working on DynamoDB metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Parity Validation Suite</name>
  <files>scripts/validate-parity.ts</files>
  <action>
    Create a script to be run "nightly" (or manually during validation):
    1. Scan DynamoDB items.
    2. For each item, verify the corresponding record in PostgreSQL matches exactly.
    3. Log any discrepancies (missing items, field mismatches).
    4. Report a "Parity %" metric.
  </action>
  <verify>Run the script and verify it reports 100% parity (or identifies known dual-write failures).</verify>
  <done>Validation suite provides automated data integrity checks.</done>
</task>

<task type="auto">
  <name>Task 3: Rollback Procedure Documentation</name>
  <files>docs/rollback-procedure.md</files>
  <action>
    Document the steps to abort the migration and revert to PostgreSQL:
    - How to disable dual-write.
    - How to verify PostgreSQL is still the source of truth.
    - How to handle data written *only* to DynamoDB (if any edge cases exist).
  </action>
  <verify>Review the document for clarity and completeness.</verify>
  <done>Rollback procedure documented and ready for emergency use.</done>
</task>

</tasks>

<verification>
Verify search accuracy and run the parity check to confirm both databases are in sync.
</verification>

<success_criteria>
1. Search results on DynamoDB are functionally equivalent to Postgres.
2. Parity script reports <1% mismatch.
3. Rollback documentation is actionable.
</success_criteria>

<output>
After completion, create `.planning/phases/05-database-migration-validation/05-04-SUMMARY.md`
</output>
