---
phase: 03-player-engagement-&-insights
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [src/lib/ai/recap.ts, src/lib/inngest/functions.ts, src/components/PlayerRecapView.tsx, src/app/sessions/[id]/page.tsx]
autonomous: true
---

<objective>
Implement the AI logic to generate player-facing recaps that selectively filter GM information based on transcripts and manual notes.

Purpose: Allow GMs to provide spoiler-free summaries to their players automatically.
Output: Selective AI prompt, updated Inngest workflow, and Player Recap UI.
</objective>

<execution_context>
@./.gemini/get-shit-done/workflows/execute-plan.md
@./.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-player-engagement-&-insights/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Selective AI Recap Prompt</name>
  <files>src/lib/ai/recap.ts</files>
  <action>
    Create a function `generatePlayerRecap` using Claude 3.5 Sonnet that:
    1. Takes the transcript, existing GM notes, and campaign context.
    2. Uses a system prompt that explicitly instructs the AI to:
       - Act as a TTRPG Archivist.
       - Use "GM Directives" (from manual notes) to filter out secrets.
       - Only include events characters actually experienced.
       - Format as immersive prose with bulleted accomplishments and threads.
    Refer to RESEARCH.md for the prompt template.
  </action>
  <verify>Call the function with a sample transcript and a "Secret" note, confirm the secret is omitted from the output.</verify>
  <done>AI prompt logic is robust and respects GM filtering directives.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Recap Generation into Inngest</name>
  <files>src/lib/inngest/functions.ts</files>
  <action>
    Update the `transcription.completed` (or similar) Inngest function to:
    1. Trigger `generatePlayerRecap` after the standard summary is created.
    2. Save the result to the `playerRecap` field in the `Session` model.
    3. Ensure error handling so a failed recap doesn't break the main transcription flow.
  </action>
  <verify>Trigger a transcription job (or manually send an inngest event) and check if `playerRecap` is populated in DB.</verify>
  <done>Player recaps are automatically generated as part of the session processing pipeline.</done>
</task>

<task type="auto">
  <name>Task 3: Implement Player Recap View UI</name>
  <files>src/components/PlayerRecapView.tsx, src/app/sessions/[id]/page.tsx</files>
  <action>
    1. Create `PlayerRecapView.tsx` to display the `playerRecap` (rendered as Markdown).
    2. Add a "Player Recap" tab or section to the Session detail page.
    3. Add a "Regenerate Recap" button for GMs to manually update the recap after editing GM notes.
  </action>
  <verify>Visit session page, switch to Player Recap tab, see the content, and trigger a regeneration.</verify>
  <done>GMs can view and manage the AI-generated player recap.</done>
</task>

</tasks>

<verification>
- Confirm AI recap differs from standard summary (less technical, no secrets).
- Verify "Regenerate" button successfully updates the `playerRecap` in DB.
</verification>

<success_criteria>
- RECAP-01: System generates player-specific recaps omitting GM secrets.
- AI uses GM notes as primary directive for inclusion/exclusion.
</success_criteria>

<output>
After completion, create `.planning/phases/03-player-engagement-&-insights/03-02-SUMMARY.md`
</output>
