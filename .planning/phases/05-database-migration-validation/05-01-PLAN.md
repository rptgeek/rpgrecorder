# 05-01-PLAN.md: Application-Level Migration from Prisma to DynamoDB

**Goal:** Replace all Prisma-based data access with the AWS SDK for DynamoDB, aligning the application with the new serverless architecture. This involves rewriting CRUD operations, authentication logic, and search functionality.

**Key Concepts:**
*   **Centralized DynamoDB Client:** A single, configured DynamoDB DocumentClient will be initialized in `src/lib/dynamodb.ts` and used throughout the application.
*   **Single-Table Design:** All data access will be rewritten to conform to the single-table schema (`PK: USER#...`, `SK: CAMPAIGN#...` or `SESSION#...`).
*   **No Data Migration:** This plan assumes a fresh start with DynamoDB; no data migration from PostgreSQL is required.

**Phase 5: Step 1 - Application-Level Migration**

## 1. Deprecate Prisma and Initialize DynamoDB Client

**Objective:** Remove the Prisma client and create a new, centralized DynamoDB client.

**Steps:**
1.1. **Create `src/lib/dynamodb.ts`:**
    *   Create a new file to initialize and export a configured DynamoDB DocumentClient from `@aws-sdk/lib-dynamodb`.
    *   This client should be configured with the appropriate AWS region from environment variables.

1.2. **Remove `src/lib/prisma.ts`:**
    *   Delete the old Prisma client file.

---
## 2. Rewrite Campaign and Session Actions

**Objective:** Replace all Prisma calls in `src/lib/actions/campaign.ts` and `src/lib/actions/session.ts` with DynamoDB SDK calls.

**Steps:**
2.1. **Rewrite `src/lib/actions/campaign.ts`:**
    *   **`createCampaign`:** Replace `prisma.campaign.create` with `PutItemCommand` to create a new campaign item. `PK` will be `USER#<sub_id>` and `SK` will be `CAMPAIGN#<campaign_id>`.
    *   **`getCampaigns`:** Replace `prisma.campaign.findMany` with `QueryCommand` where `PK` is `USER#<sub_id>` and `SK` begins with `CAMPAIGN#`.
    *   **`getCampaignById`:** Replace `prisma.campaign.findUnique` with `GetItemCommand` using the full `PK` and `SK`.
    *   **`updateCampaign`:** Replace `prisma.campaign.update` with `UpdateItemCommand`.
    *   **`deleteCampaign`:** Replace `prisma.campaign.delete` with `DeleteItemCommand`.
    *   **Handle `include: { sessions: ... }`:** To get sessions for a campaign, implement a separate `Query` operation where `PK` is `CAMPAIGN#<campaign_id>` and `SK` begins with `SESSION#` (assuming sessions are also stored with a campaign-specific PK, or query on a GSI).

2.2. **Rewrite `src/lib/actions/session.ts`:**
    *   Apply the same `Command` replacement strategy for all CRUD functions.
    *   **Handle `include: { campaign: true }`:** To get campaign data for a session, either:
        a)  Denormalize essential campaign data (like name) onto the session item itself.
        b)  Perform a separate `GetItem` call for the campaign.

---
## 3. Update Authentication Logic

**Objective:** Replace Prisma in `src/auth.ts` to use DynamoDB for user provisioning.

**Steps:**
3.1. **Modify `signIn` Callback in `src/auth.ts`:**
    *   Replace `prisma.user.findUnique` and `prisma.user.create` with a single `PutItemCommand` for the User entity.
    *   `PK` will be `USER#<cognito_sub>` and `SK` will be `METADATA#<cognito_sub>`.
    *   `PutItem` will naturally handle both creating a new user and updating an existing one (upsert).

---
## 4. Address Full-Text Search

**Objective:** Replace the PostgreSQL-specific full-text search in `src/lib/search/fts.ts`.

**Steps:**
4.1. **Analyze `src/lib/search/fts.ts`:** Review the existing raw SQL query (`$queryRaw`).
4.2. **Choose a Strategy:**
    *   **Option A (Recommended for now): Remove the feature.** Full-text search is a significant feature that requires a dedicated service like AWS OpenSearch. Given the focus on migration, deferring this feature is the simplest path.
    *   **Option B (Simplified): Use `FilterExpression`**. Implement a basic search using a DynamoDB `Scan` with a `FilterExpression` and a `contains()` function on the transcript text. **Important:** Add a note in the code and documentation that this is not a scalable solution and will have performance limitations, as `Scan` reads the entire table.

---
## 5. Update Background Jobs and API Routes

**Objective:** Replace Prisma in Inngest functions and other API routes.

**Steps:**
5.1. **Rewrite `src/lib/inngest/functions.ts` and `src/app/api/inngest/events/route.ts`:**
    *   Replace `prisma.session.findUnique` with `GetItemCommand`.
    *   Replace `prisma.session.update` with `UpdateItemCommand`.

5.2. **Rewrite `src/app/api/campaigns/route.ts` (and similar API routes):**
    *   Assume these files use Prisma for data access and rewrite them to use the DynamoDB client and appropriate commands.

---
**Dependencies:**
*   `@aws-sdk/lib-dynamodb` and `@aws-sdk/client-dynamodb` packages installed.
*   A clear understanding of the single-table design from `05-05-PLAN.md` (which should be renamed to reflect the new direction).

**Acceptance Criteria:**
*   All Prisma-related code is removed from the application.
*   The application functions correctly using data from DynamoDB.
*   All tests (if any) are updated to reflect the new data access layer.