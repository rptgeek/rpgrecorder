---
phase: 03-player-engagement-&-insights
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [prisma/schema.prisma, src/lib/metrics/parser.ts, src/app/sessions/[id]/page.tsx, src/components/SpeakerStats.tsx]
autonomous: true
---

<objective>
Establish the data foundation for session insights and implement the basic metrics parsing and display.

Purpose: Provide GMs with statistical overview (duration, word count, speakers) directly on the session page.
Output: Updated schema, metrics parsing logic, and visual speaker distribution UI.
</objective>

<execution_context>
@./.gemini/get-shit-done/workflows/execute-plan.md
@./.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-player-engagement-&-insights/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Schema and Setup Dependencies</name>
  <files>prisma/schema.prisma, package.json</files>
  <action>
    1. Install `nanoid` and `@react-pdf/renderer`.
    2. Update `Session` model in `prisma/schema.prisma` to include:
       - `shareToken`: String (unique, @default(uuid()) for simplicity in schema, but we will use nanoid in logic if preferred. Actually, let's use `@default(cuid())` or just a String and populate with nanoid in code).
       - `playerRecap`: String?
       - `speakerNames`: Json? (mapping spk_0 -> "Name")
       - `metrics`: Json? (duration, wordCount, distribution)
    3. Run `npx prisma db push` to update the database.
  </action>
  <verify>`npx prisma validate` passes and `package.json` contains new libraries.</verify>
  <done>Database schema updated and dependencies installed.</done>
</task>

<task type="auto">
  <name>Task 2: Implement Metrics Parser</name>
  <files>src/lib/metrics/parser.ts</files>
  <action>
    Create a utility to parse AWS Transcribe JSON (stored in `transcriptJson`) to calculate:
    - Total session duration (end_time of last segment).
    - Total word count.
    - Speaker distribution (seconds and words per speaker ID).
    
    Refer to RESEARCH.md for the parsing logic example.
  </action>
  <verify>Create a small test script or use `check_fts.ts` as a template to verify parser with existing `transcriptJson` in DB.</verify>
  <done>Parser successfully extracts duration, word count, and speaker breakdown from AWS data.</done>
</task>

<task type="auto">
  <name>Task 3: Display Metrics and Speaker Mapping UI</name>
  <files>src/app/sessions/[id]/page.tsx, src/components/SpeakerStats.tsx</files>
  <action>
    1. Create `SpeakerStats.tsx` component to visualize speaker distribution using simple CSS bars (per Claude's discretion).
    2. Update `Session` detail page to:
       - Calculate/fetch metrics using the parser.
       - Display "Session length", "Word count", and the `SpeakerStats` component.
       - Add a simple "Rename" button for speaker IDs (spk_0, spk_1) that updates the `speakerNames` Json field in the database.
  </action>
  <verify>Visit a session detail page and see the duration, word count, and speaker chart.</verify>
  <done>Metrics are visible on the session page and speakers can be renamed.</done>
</task>

</tasks>

<verification>
- Check `prisma/schema.prisma` for new fields.
- Verify `SpeakerStats` renders correctly with real session data.
- Confirm speaker renaming persists after refresh.
</verification>

<success_criteria>
- METRICS-01: Session length, word count, and unique speakers are displayed.
- Visual speaker distribution is rendered on the Session detail page.
</success_criteria>

<output>
After completion, create `.planning/phases/03-player-engagement-&-insights/03-01-SUMMARY.md`
</output>
